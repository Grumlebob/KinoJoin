@inject IJSRuntime JsRuntime 
@inject NavigationManager NavigationManager
@inject IKinoJoinHttpClient KinoJoinHttpClient
<div class="flex flex-col items-start justify-start gap-2 rounded bg-slate-50 p-5 text-start shadow-md text-wrap">

    <!-- Movie title and tags -->
    <div class="md:gap-1 md:h-24">
        <div class="flex w-full items-center gap-2">
            <div class="flex w-full items-center gap-1">
                <p class="font-bold">
                    @Showtime.Movie.Title
                </p>
            </div>
        </div>

        <p class="text-xs font-normal text-gray-700 md:hidden">@Showtime.VersionTag.Type</p>
        <div class="hidden md:flex-col md:flex">
            @foreach (var version in Showtime.VersionTag.Type.Split("-"))
            {
                <p class="text-xs font-normal text-gray-700">@version.Trim()</p>
            }
        </div>
    </div>

    <!-- Cinema name and room -->
    <hr class="h-px w-full rounded-full bg-gray-300"/>
    <div class="gap-1 md:h-24">
        <div class="flex w-full items-center gap-1">
            <p class="font-normal">
                @Showtime.Cinema.Name
            </p>
        </div>

        <div class="flex w-full items-center gap-1">
            <p class="text-xs font-normal text-gray-700">@Showtime.Room.Name</p>
        </div>
    </div>

    <hr class="h-px w-full rounded-full bg-gray-300"/>

    <!-- Showtime playtime -->
    <div class="flex h-full w-full flex-col justify-end gap-2">
        <div class="flex h-full flex-col justify-end gap-1">
            <div class="flex w-full items-center gap-1">
                <img src="Icons/DateIcon.svg" alt="date icon"/>
                <p class="font-normal">
                    @Showtime.Playtime.StartTime.ToString("dd. MMM").
                </p>

                <p class="md:hidden"> - @Showtime.Playtime.StartTime.ToString("HH:mm") - @Showtime.Playtime.StartTime.AddMinutes(Showtime.Movie.DurationInMinutes ?? 0).ToString("HH:mm") </p>

            </div>

            <div class="hidden w-full items-center gap-1 md:flex">
                <p class="text-sm font-normal">
                    @Showtime.Playtime.StartTime.ToString("HH:mm") - @Showtime.Playtime.StartTime.AddMinutes(Showtime.Movie.DurationInMinutes ?? 0).ToString("HH:mm")
                </p>
            </div>
        </div>

        @if (IsHost)
        {
            <hr class="h-px w-full rounded-full bg-gray-300 md:hidden"/>
        }

        <!-- Check icon, se stemmer, bekræft event -->
        <div class="flex w-full items-center gap-1">
            @if (HasVoted && Vote != null && Vote.SelectedOptionId != JoinEvent.DefaultSelectOptionId)
            {
                <div class="flex w-full items-center gap-1 md:hidden">
                    <CheckIconComp Class="@("stroke-" + Vote.SelectedOption.Color)"/>
                </div>
            }

            <div class="flex h-fit w-full items-end justify-end gap-1 md:items-start md:justify-start">

                <button class="btn-white md:hidden" @onclick="@(async () => await JsRuntime.InvokeVoidAsync("customFunctions.showDialog", $"votesDialog{UniqueId}{Showtime.Id}"))">
                    Se stemmer (@JoinEvent.Participants.Count(p => p.VotedFor.Any(v => v.ShowtimeId == Showtime.Id && v.SelectedOptionId != JoinEvent.DefaultSelectOptionId)))
                </button>
                @if (JoinEvent.ChosenShowtimeId == Showtime.Id)
                {
                    <div class="flex justify-center rounded-full bg-opacity-25 font-normal py-[14px] px-[15px] bg-success text-nowrap text-success-darkest">
                        <p>Aftalt tid</p>
                        <button class="rounded-full p-1 hover:bg-success" @onclick="@(async () => { await JsRuntime.InvokeVoidAsync("customFunctions.showDialog", "afterConfirmActions" + Showtime.Id + UniqueId); })">
                            <img src="Icons/ThreeDotsIcon.svg" alt="options"/>
                        </button>
                    </div>
                }

                @if (IsHost && JoinEvent.ChosenShowtimeId != Showtime.Id)
                {
                    <button class="btn-red" onclick="@(() => OpenConfirmationDialog(Showtime.Id))">Bekræft event</button>
                }
            </div>
        </div>
    </div>

</div>

<dialog id="@($"votesDialog{UniqueId}{Showtime.Id}")" class="fixed w-full max-w-md rounded p-4 bg-slates-300 xs:h-dvh">

    <div class="mb-4 flex justify-between">
        <h4 class="text-lg font-bold">Stemmer</h4>
        <button onclick="@(async () => await JsRuntime.InvokeVoidAsync("customFunctions.hideDialog", $"votesDialog{UniqueId}{Showtime.Id}"))">
            <img src="Icons/CrossIcon.svg" alt="close"/>
        </button>
    </div>
    @{ var participantsAndVotes = JoinEvent.Participants?.Where(p => p.VotedFor.Any(v => v.ShowtimeId == Showtime.Id)).Select(p => (p, p.VotedFor.First(v => v.ShowtimeId == Showtime.Id))).ToList(); }
    @foreach (var (participant, vote) in participantsAndVotes)
    {
        <div class="flex w-full justify-between gap-2">
            <p>@participant.Nickname</p>
            <CheckIconComp Class="@("stroke-" + vote.SelectedOption.Color)"/>
        </div>
    }
</dialog>

<dialog class="rounded p-5" id="@("confirmEvent" + Showtime.Id + UniqueId)">
    <div class="flex flex-col items-end gap-4">
        <h2 class="text-xl font-bold">Ønsker du at bekræfte forestillingen for dette event?</h2>
        <div class="flex gap-1">
            <button class="btn-white" onclick="@(async () => await JsRuntime.InvokeVoidAsync("customFunctions.hideDialog", "confirmEvent" + Showtime.Id + UniqueId))">Nej</button>
            <button class="btn-black" onclick="@(async () => { await OpenDetailsDialog(Showtime, Showtime.Id); await JsRuntime.InvokeVoidAsync("customFunctions.hideDialog", "confirmEvent" + Showtime.Id + UniqueId); })">Ja</button>
        </div>
    </div>
</dialog>

@code {

    [Parameter] public required Showtime Showtime { get; set; }

    [Parameter] public required JoinEvent JoinEvent { get; set; }

    [Parameter] public bool HasVoted { get; set; }

    [Parameter] public ParticipantVote? Vote { get; set; }

    [Parameter] public required string UniqueId { get; set; }

    [Parameter] public bool IsHost { get; set; }

    [Parameter] public EventCallback OnEventConfirmed { get; set; }

    private async Task OpenDetailsDialog(Showtime showtime, int index)
    {
        JoinEvent.ChosenShowtimeId = showtime.Id;
        await KinoJoinHttpClient.PutJoinEventAsync(JoinEvent);
        await OnEventConfirmed.InvokeAsync();
        await JsRuntime.InvokeVoidAsync("customFunctions.showDialog", "afterConfirmActions" + index + UniqueId);
    }

    private async Task OpenConfirmationDialog(int index)
    {
        await JsRuntime.InvokeVoidAsync("customFunctions.showDialog", "confirmEvent" + index + UniqueId);
    }

}