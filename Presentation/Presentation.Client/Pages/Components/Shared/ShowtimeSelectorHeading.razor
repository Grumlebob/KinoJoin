@inject IJSRuntime JsRuntime


@if (ShowDivider)
{
    <hr class="bg-gray-300 rounded-full w-full h-px my-5"/>
}
<div class="grid gap-4  grid-cols-[0.5fr_1fr] grid-rows-[min-content_auto] md:grid-cols-[200px_1fr]">
    <!-- PosterImage -->
    @if (_shouldRender)
    {
        <div class="row-span-2 space-y-2 md:min-w-48 md:sticky md:top-16 md:row-span-3 md:self-start">
            <a href=@($"https://kino.dk{Movie.KinoURL}") target="_blank">
                <img src="@Movie.ImageUrl" alt="Movie Poster" class="w-full max-h-full rounded-sm shadow"/>
            </a>
            <!--Læs mere og trailer-->
            <div class="hidden flex-col items-center md:flex space-y-1 px-3">

                <a href=@($"https://kino.dk{Movie.KinoURL}") target="_blank" class="rounded-full border text-center border-black shadow duration-300 transition px-3 py-2 font-label hover:bg-neutral-950 hover:text-white w-full">Læs mere</a>

                <button class="rounded-full border border-black shadow duration-300 transition px-3 py-2 font-label hover:bg-neutral-950 hover:text-white w-full" @onclick="async () => { await ShowMovieTrailer(Movie); }">Se trailer</button>
            </div>
        </div>
    }

    <!-- MovieHeader -->
    <div class="col-start-2">
        <div class="flex flex-col space-y-2">
            <div class="flex justify-between">
                <a href=@($"https://kino.dk{Movie.KinoURL}") target="_blank" class="block w-fit text-black no-underline divide-y-8">
                    <h2 class="text-2xl font-bold md:text-4xl">@Movie.Title</h2>
                </a>
                <button @onclick="ToggleCollapse" class="translate-x-8">
                    <svg class="transition-transform" style="@(_shouldRender ? "transform: rotate(0deg)" : "transform: rotate(-180deg)")" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>

        </div>
        @if (_shouldRender)
        {
                <div class="inline-flex flex-col items-start justify-between gap-2 rounded md:flex-row md:items-center md:gap-4 md:p-2">
                    <!-- movie-info -->
                    @if (Movie.PremiereDate != null)
                    {
                        <div class="flex space-x-1">
                            <span class="hidden text-sm text-neutral-400 font-label md:block">Premiere</span>
                            <span class="text-sm text-neutral-400 font-label">@Movie.PremiereDate </span>
                        </div>
                    }
                    @if (Movie.PremiereDate != null && Movie.Duration != 0)
                    {
                        <span class="hidden text-sm text-neutral-400 md:block">|</span>
                    }
                    @if (Movie.Duration != 0)
                    {
                        <div class="flex space-x-1">
                            <span class="hidden text-sm text-neutral-400 font-label md:block">Varighed</span>
                            <span class="text-sm text-neutral-400 font-label">@Movie.Duration min</span>
                        </div>
                    }
            <div class="block md:hidden">
                <!--Læs mere og trailer mobile-->
                <a href=@($"https://kino.dk{Movie.KinoURL}") target="_blank" class="inline-block w-32 rounded-full border border-black px-3 py-2 text-center transition duration-100 font-label hover:bg-neutral-950 hover:text-white">Læs mere</a>
            </div>
            <div class="block md:hidden">
                <button @onclick="async () => { await ShowMovieTrailer(Movie); }" class="inline-block w-32 rounded-full border border-black px-3 py-2 transition duration-100 font-label hover:bg-neutral-950 hover:text-white">Se trailer</button>
            </div>
            </div>
        }
    </div>


    <div class="col-span-3 md:col-start-2 md:row-start-2 md:row-end-3@(HasAnswered ? "opacity-50" : "")">
        @if (_shouldRender)
        {
            @if (ChildContent is not null)
            {
                @ChildContent
            }
        }
    </div>
</div>

@if (_trailerUrl != null)
{
    <div class="fixed top-0 left-0 h-screen w-screen flex items-center justify-center">
        <div class="relative w-3/5 h-3/5">
            <!-- Adjust width and height as necessary -->
            <iframe src="@_trailerUrl" width="100%" height="100%" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
            </iframe>
            <button class="absolute top-0 right-0 mt-2 mr-2 rounded bg-error hover:bg-error-dark" onclick="@(() => { _trailerUrl = null; })">
                <CrossIcon Class="fill-white"/>
            </button>
        </div>
    </div>
}


@code {


    [Parameter] public required Movie Movie { get; set; }

    // add children
    [Parameter] public RenderFragment? ChildContent { get; set; }

    [Parameter] public bool HasAnswered { get; set; }

    [Parameter] public bool ShowDivider { get; set; } = true;

    private string? _trailerUrl;

    private bool _shouldRender = true;

    private async Task ShowMovieTrailer(Movie movie)
    {
        var client = new HttpClient();
        var apiString = $"https://api.kino.dk{movie.KinoURL}?region=content&format=json";
        var json = await client.GetStringAsync(apiString);

        var movieRoot = JsonConvert.DeserializeObject<MovieRoot>(json);
        if (movieRoot?.Content?.field_trailer?.FieldMediaOembedVideo?.trailerUrl == null) //no video found
        {
            await JsRuntime.InvokeVoidAsync("open", $"https://www.youtube.com/results?search_query={movie.Title}+trailer", "_blank"); //search in youtube
            return;
        }

        var uri = new Uri(movieRoot.Content.field_trailer.FieldMediaOembedVideo.trailerUrl);
        var videoId = uri.Segments.Last() == "watch" ? HttpUtility.ParseQueryString(uri.Query)["v"] : uri.Segments.Last();

        if (videoId == null) await JsRuntime.InvokeVoidAsync("open", $"https://www.youtube.com/results?search_query={movie.Title}+trailer", "_blank"); //search in youtube
        else _trailerUrl = $"https://www.youtube.com/embed/{videoId}";
    }

    private void ToggleCollapse()
    {
        _shouldRender = !_shouldRender;
    }

}
