@page "/"
@page "/create-event/{FilterString?}"
@inject NavigationManager NavigationManager
@inject IJSRuntime JsRuntime
@inject IKinoJoinHttpClient KinoJoinHttpClient
@inject IKinoDkService KinoDkService


@if (_loadingPage)
{
    <LoadingTextAndCircle/>
    return;
}


<h1 class="text-secondary mb-6 text-2xl font-bold leading-tight md:text-2xl lg:text-3xl">
    Velkommen til KinoJoin - Planlæg dit biograf event her
</h1>


@* Dialog where user enters title and other event details *@
<dialog id="eventDetailsDialog" class="mx-auto my-12 max-w-lg rounded-lg bg-white p-6 shadow-xl">
    <form @onsubmit="ValidateAndOpenConfirmationDialog">
        <p class="text-lg font-semibold mb-0.5">Event Titel</p>
        <input class="mb-2 w-full rounded-md border border-gray-300 px-4 py-2 shadow-sm focus:border-transparent focus:outline-none focus:ring-4 focus:ring-secondary  md:w-96"
               type="text" placeholder="Titel" required
               @bind="_joinEvent.Title"/>

        <p class="text-lg font-semibold  mb-0.5">Event Beskrivelse</p>
        <textarea class="mb-2 w-full rounded-md border border-gray-300 px-4 py-2 shadow-sm focus:border-transparent focus:outline-none focus:ring-4 focus:ring-secondary md:w-96"
                  placeholder="Beskrivelse (valgfrit)" 
                  @bind="@_joinEvent.Description"></textarea>

        <p class="text-lg font-semibold mb-0.5">Deadline</p>
        <input class="mb-2 w-full rounded-md border border-gray-300 px-4 py-2 shadow-sm focus:border-transparent focus:outline-none focus:ring-4 focus:ring-secondary md:w-96"
               type="date" placeholder="Deadline" value="@_joinEvent.Deadline.ToLocalTime().ToString("yyyy-MM-dd")" @oninput="@(v => { if (DateTime.TryParse(v.Value?.ToString(), CultureInfo.InvariantCulture, DateTimeStyles.AssumeUniversal, out var parsedDate)) _joinEvent.Deadline = parsedDate; })"/>
        <div class="flex justify-end space-x-3">
            <button type="button" @onclick="@(() => JsRuntime.InvokeVoidAsync("customFunctions.hideDialog", "eventDetailsDialog"))" class="rounded-full bg-error px-4 py-2 text-white hover:bg-error-dark focus:outline-none focus:ring-2 ">Annuller</button>
            <button type="submit" class="rounded-full bg-success px-4 py-2 text-white hover:bg-success-dark focus:outline-none focus:ring-2 focus:ring-green-400">Opret</button>
        </div>
    </form>
</dialog>

@* Dialog to confirm the user is done creating the event *@
<dialog id="eventConfirmDialog" class="mx-auto my-12 max-w-lg rounded-lg bg-white p-6 shadow-xl min-w-96">
    <p class="text-lg font-semibold  mb-0.5">Bekræft oprettelse</p>
    <div class="mb-4 flex items-center">
        <input id="CanAllShowtimes" type="checkbox" @bind="_hostCanAllShowtimes" class="mr-2 accent-secondary"/>
        <label for="CanAllShowtimes" class="text-md">
            @(_hostCanAllShowtimes ? "Jeg kan alle valgte tider" : "Jeg ønsker selv at angive tider hvor jeg kan")
        </label>
    </div>
    <div class="flex justify-end space-x-3">
        <button @onclick="@(() => JsRuntime.InvokeVoidAsync("customFunctions.hideDialog", "eventConfirmDialog"))" class="rounded-full bg-error px-4 py-2 text-white hover:bg-error-dark ">Rediger videre</button>
        <button @onclick="FinishJoinEvent" class="rounded-full bg-success px-4 py-2 text-white hover:bg-success-dark ">Opret</button>
    </div>
</dialog>

@* Dialog which shows the share link *@
<dialog id="eventShareDialog" class="mx-auto my-12 max-w-lg rounded-lg bg-white p-6 shadow-xl min-w-96">
    <div class="space-y-1">
        <p class="text-lg font-semibold  mb-0.5">Dit event er nu oprettet</p>
        <p class="font-semibold">Send dette link til dine venner</p>
        <div class="flex items-center gap-4">
            <a href="@(_baseUrl + "filling/" + _joinEvent.Id)" class="text-lg text-blue-600 hover:text-blue-700">
                @(_baseUrl + "filling/" + _joinEvent.Id)
            </a>
            <button @onclick="ShareEvent" class="rounded-full bg-secondary p-2 text-white hover:bg-gray-700 ">
                <svg class="h-5 w-5 fill-white" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="100" height="100" viewBox="0 0 30 30">
                    <path d="M 23 3 A 4 4 0 0 0 19 7 A 4 4 0 0 0 19.09375 7.8359375 L 10.011719 12.376953 A 4 4 0 0 0 7 11 A 4 4 0 0 0 3 15 A 4 4 0 0 0 7 19 A 4 4 0 0 0 10.013672 17.625 L 19.089844 22.164062 A 4 4 0 0 0 19 23 A 4 4 0 0 0 23 27 A 4 4 0 0 0 27 23 A 4 4 0 0 0 23 19 A 4 4 0 0 0 19.986328 20.375 L 10.910156 15.835938 A 4 4 0 0 0 11 15 A 4 4 0 0 0 10.90625 14.166016 L 19.988281 9.625 A 4 4 0 0 0 23 11 A 4 4 0 0 0 27 7 A 4 4 0 0 0 23 3 z"></path>
                </svg>
            </button>
        </div>
        @if (!_hostCanAllShowtimes)
        {
            <p>Angiv hvilke tider du selv kan ved at gå ind på linket</p>
        }
    </div>
</dialog>


<div class="flex ">
    <button @onclick="ToggleFilters" class="mb-4 rounded-full lg:hidden border border-transparent bg-secondary px-6 py-2 text-base font-medium text-white shadow-sm max-w-40 hover:bg-gray-800">
        @(_showAllFilters ? "Skjul filtrer" : "Vis alle filtrer")
    </button>
</div>

<div id="ShowAllFilters" class="@(_showAllFilters ? "" : "hidden lg:block")">
    <div class="flex flex-col lg:space-x-4 lg:flex-row">
        <div class="mt-4 lg:mt-0 lg:w-1/3">
            <SearchableCheckboxList @ref="cinemaCheckBoxList" IconPath="/Icons/CinemaFilterIcon.svg" FilterTitle="Vælg biografer" SelectedItems="_selectedCinemas" IdsToLabels="@_cinemaIdsToNames"/>
        </div>
        <div class="lg:w-1/3">
            <SearchableCheckboxList @ref="movieCheckBoxList" IconPath="Icons/MovieFilterIcon.svg" FilterTitle="Vælg film" SelectedItems="_selectedMovies" IdsToLabels="@_movieIdsToNames"/>
        </div>
        <div class="lg:mt-0 lg:w-1/3">
            <SearchableCheckboxList @ref="genreCheckBoxList" IconPath="Icons/GenreFilterIcon.svg" FilterTitle="Vælg genrer" SelectedItems="_selectedGenres" IdsToLabels="@_genreIdsToNames"/>
        </div>
    </div>

    <div class="flex flex-col space-y-4 mt-4 lg:mt-0 lg:w-1/3 lg:pr-3">
        <div class="flex flex-wrap justify-start w-full">
            <div class="w-1/2 pr-1.5 pt-3">
                <div class="rounded bg-gray-100 shadow">
                    <label for="start-date" class="block rounded-t bg-secondary text-center text-sm font-medium text-white">Start dato</label>
                    <input id="start-date" type="date" @bind="_startDate" class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm"/>
                </div>
            </div>
            <div class="w-1/2 pl-1.5 pt-3">
                <div class="rounded bg-gray-100 shadow ">
                    <label for="end-date" class="block rounded-t bg-secondary text-center text-sm font-medium text-white">Slut dato</label>
                    <input id="end-date" type="date" @bind="_endDate" class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm"/>
                </div>
            </div>
        </div>
        <button @onclick="HandleShowtimeFiltersChanged" class="rounded-full border border-transparent bg-secondary px-6 py-2 text-base font-medium text-white shadow-sm max-w-40 hover:bg-gray-800">
            Opdater filtrer
        </button>
    </div>
</div>


@if (_loadingShowtimes)
{
    <div class="mt-5">
        <LoadingTextAndCircle Text="Indlæser spilletider"/>
    </div>
    return;
}

@if (_selectedCinemas.Count == 0 && _selectedMovies.Count == 0)
{
    <div class="mt-2 border rounded p-2 w-fit">
        <p class="text-xl">Vælg mindst én biograf, film eller genre.</p>
    </div>
    return;
}


@if (_availableShowtimes.Count == 0)
{
    if (_selectedCinemas.Count > 0 || _selectedMovies.Count > 0)
    {
        <p>Der er ingen forestillinger for de valgte filtre</p>
    }
    else
    {
        <p>Du skal vælge mindst en film eller biograf til filteret</p>
    }
}

<ShowtimeSelector Showtimes="@_availableShowtimes" LegendTitle="Klik på de tider du vil have med i dit event" MoviesWithOutShowTimes="@_moviesWithoutShowtimes" Votes="@_availableShowtimeVotes" VotesChanged="OnVoteChange" SelectOptions="_hostSelectOptions"/>

<button class="w-14 h-14  md:w-auto md:h-auto  md:px-4 md:py-2 fixed bottom-12 right-12 z-50 shadow-lg rounded-full bg-primary flex items-center justify-center hover:bg-primary-dark gap-1" @onclick="OpenEventDetailsDialog">
    <CreateIcon Class="stroke-white fill-white"/>
    <span class="hidden md:block text-white py-1">
        Opret Event
    </span>
</button>

@if (_snackbarMessage != null)
{
    <div class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-red-600 text-white p-2.5 rounded-md">
        @_snackbarMessage
    </div>
}


@code {
    [CascadingParameter] private Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;

    [Parameter] public string FilterString { get; set; } = "";

    private readonly JoinEvent _joinEvent = new()
    {
        SelectOptions =
        [
            new() { VoteOption = "Kan ikke", Color = "gray-200" },
            new() { VoteOption = "Kan godt", Color = "success" },
            new() { VoteOption = "Hvis Nødvendigt (Klik to gange)", Color = "warning" }
        ],
        Deadline = DateTime.Today.AddDays(30)
    };

    private string? _snackbarMessage;

    private bool _hostCanAllShowtimes = true;

    private bool _loadingPage = true;
    private bool _loadingShowtimes = true;

    string _baseUrl = "";

    List<Showtime> _availableShowtimes = [];
    List<Movie> _moviesWithoutShowtimes = [];
    ICollection<ParticipantVote> _availableShowtimeVotes = []; //used to keep track of which showtimes are selected and not selected

    readonly List<SelectOption> _hostSelectOptions = [new SelectOption { VoteOption = "Ikke valgt", Color = "gray-200" }, new SelectOption { VoteOption = "Valgt", Color = "success" }];
    const int NoVoteIndex = 0; //when you vote no
    const int YesVoteIndex = 1;

    //used for filters
    SearchableCheckboxList cinemaCheckBoxList;
    SearchableCheckboxList movieCheckBoxList;
    SearchableCheckboxList genreCheckBoxList;
    
    Dictionary<int, string> _movieIdsToNames = new();
    Dictionary<int, string> _cinemaIdsToNames = new();
    Dictionary<int, string> _genreIdsToNames = new();

    HashSet<int> _selectedMovies = [];
    HashSet<int> _selectedCinemas = [];
    HashSet<int> _selectedGenres = [];

    private DateTime _startDate = DateTime.Today;
    private DateTime _endDate = DateTime.Today.AddDays(30);

    private bool _showAllFilters;

    private void ToggleFilters()
    {
        _showAllFilters = !_showAllFilters;
    }
    //filters end


    protected override async Task OnInitializedAsync()
    {
        _baseUrl = NavigationManager.BaseUri;
        _joinEvent.DefaultSelectOption = _joinEvent.SelectOptions[NoVoteIndex];

        _cinemaIdsToNames = new Dictionary<int, string>();
        _movieIdsToNames = new Dictionary<int, string>();
        _genreIdsToNames = new Dictionary<int, string>();

        SetFiltersFromFilterString(FilterString);

        //get data for filter checklists
        var cinemasTask = KinoJoinHttpClient.GetCinemasAsync();
        var moviesTask = KinoJoinHttpClient.GetMoviesAsync();
        var genresTask = KinoJoinHttpClient.GetGenresAsync();

        await Task.WhenAll(cinemasTask, moviesTask, genresTask); //run in parallel

        var availableCinemas = await cinemasTask;
        var availableMovies = await moviesTask;
        var availableGenres = await genresTask;

        _cinemaIdsToNames = availableCinemas == null ? [] : availableCinemas.Select(c => (c.Id, c.Name)).ToDictionary();
        _selectedCinemas = _selectedCinemas.Intersect(_cinemaIdsToNames.Keys).ToHashSet(); //cannot select cinemas not in list

        _movieIdsToNames = availableMovies == null ? [] : availableMovies.Select(c => (c.Id, c.Title)).ToDictionary();
        _selectedMovies = _selectedMovies.Intersect(_movieIdsToNames.Keys).ToHashSet();

        _genreIdsToNames = availableGenres == null ? [] : availableGenres.Select(c => (c.Id, c.Name)).ToDictionary();
        _selectedGenres = _selectedGenres.Intersect(_genreIdsToNames.Keys).ToHashSet();

        _loadingPage = false;
        StateHasChanged();

        if (_selectedCinemas.Count == 0 && _selectedMovies.Count == 0)
        {
            _loadingShowtimes = false;
            _showAllFilters = true;
            return;
        }

        //load all show times from filter
        (_availableShowtimes, _moviesWithoutShowtimes) = await KinoDkService.GetShowtimesFromFilters(_selectedCinemas, _selectedMovies, _selectedGenres, _startDate, _endDate);
        _availableShowtimeVotes = _availableShowtimes.Select(s => new ParticipantVote { ShowtimeId = s.Id, SelectedOption = _hostSelectOptions[NoVoteIndex] }).ToList();

        _loadingShowtimes = false;
    }

    /**
     * <remarks>This will set the selected movies, cinemas etc used for the filters.</remarks>
     */
    private void SetFiltersFromFilterString(string filterString)
    {
        var query = "?" + filterString;
        var queryParams = HttpUtility.ParseQueryString(query);

        //&movies=1&movies=2 -> SelectedMovies = [1, 2]
        var firstDate = true;
        foreach (var key in queryParams.AllKeys)
        {
            if (key == null) continue;
            foreach (var value in queryParams.GetValues(key)!)
            {
                switch (key)
                {
                    case "cinemas" when int.TryParse(value, out var cinemaId):
                        _selectedCinemas.Add(cinemaId);
                        break;
                    case "movies" when int.TryParse(value, out var movieId):
                        _selectedMovies.Add(movieId);
                        break;
                    case "genres" when int.TryParse(value, out var genreId):
                        _selectedGenres.Add(genreId);
                        break;
                    case "date" when DateTime.TryParse(value, out var parsedDate):
                        if (firstDate)
                        {
                            _startDate = parsedDate.Date;
                            firstDate = false;
                        }
                        else
                        {
                            _endDate = parsedDate.Date.AddHours(23).AddMinutes(59);
                        }

                        break;
                }
            }
        }
    }

    /**
     * <summary>
     * This will update the filter string in the url and load new show times that match the updated filters
     * </summary>
     */
    private async Task HandleShowtimeFiltersChanged()
    {
        cinemaCheckBoxList.CloseAccordion();
        movieCheckBoxList.CloseAccordion();
        genreCheckBoxList.CloseAccordion();
        _loadingShowtimes = true;
        StateHasChanged();
        var movieIds = _selectedMovies.ToList();
        var cinemaIds = _selectedCinemas.ToList();
        var genreIds = _selectedGenres.ToList();
        var fromDate = _startDate.ToString("O");
        var toDate = _endDate.ToString("O");

        if (movieIds.Count == 0 && cinemaIds.Count == 0)
        {
            _loadingShowtimes = false;
            return;
        }

        var filterStringBuilder = new StringBuilder("sort=most_purchased");

        foreach (var id in movieIds)
        {
            filterStringBuilder.Append($"&movies={id}");
        }

        foreach (var id in cinemaIds)
        {
            filterStringBuilder.Append($"&cinemas={id}");
        }

        foreach (var id in genreIds)
        {
            filterStringBuilder.Append($"&genres={id}");
        }

        filterStringBuilder.Append($"&date={fromDate}");
        filterStringBuilder.Append($"&date={toDate}");

        var newUrl = _baseUrl + "create-event/" + filterStringBuilder;
        NavigationManager.NavigateTo(newUrl); //change url so a page reload will save the filters

        (_availableShowtimes, _moviesWithoutShowtimes) = await KinoDkService.GetShowtimesFromFilters(_selectedCinemas, _selectedMovies, _selectedGenres, _startDate, _endDate.AddHours(23).AddMinutes(59));

        // Save votes for show times that were there before update 
        var stillAvailableShowtimeIds = new HashSet<int>(_availableShowtimeVotes
            .Select(v => v.ShowtimeId)
            .Intersect(_availableShowtimes.Select(s => s.Id)));

        // Remove votes for show times that are no longer available
        var votesToRemove = _availableShowtimeVotes
            .Where(v => !stillAvailableShowtimeIds.Contains(v.ShowtimeId))
            .ToList();

        foreach (var vote in votesToRemove)
        {
            _availableShowtimeVotes.Remove(vote);
        }

        // Add new votes for newly available showtimes
        var newVotes = _availableShowtimes
            .Where(s => !stillAvailableShowtimeIds.Contains(s.Id))
            .Select(s => new ParticipantVote { ShowtimeId = s.Id, SelectedOption = _hostSelectOptions[NoVoteIndex] })
            .ToList();

        foreach (var newVote in newVotes)
        {
            _availableShowtimeVotes.Add(newVote);
        }

        _loadingShowtimes = false;
    }

    private async Task OpenEventDetailsDialog()
    {
        if (_joinEvent.Showtimes.Count < 1)
        {
            _snackbarMessage = "Vælg mindst en mulig forestilling";
            await Task.Delay(3000).ContinueWith(_ => _snackbarMessage = null);
        }
        else
        {
            await JsRuntime.InvokeVoidAsync("customFunctions.showDialog", "eventDetailsDialog");
        }
    }

    private async Task ShareEvent()
    {
        var data = new
        {
            title = _joinEvent.Title,
            text = _joinEvent.Description,
            url = _baseUrl + "filling/" + _joinEvent.Id
        };

        await JsRuntime.InvokeVoidAsync("navigator.share", data);
    }

    private async Task ValidateAndOpenConfirmationDialog()
    {
        if (_joinEvent.Showtimes.Count < 1)
        {
            _snackbarMessage = "Vælg mindst en mulig forestilling";
            await Task.Delay(3000).ContinueWith(_ => _snackbarMessage = null);
        }
        else if (string.IsNullOrEmpty(_joinEvent.Title.Trim()))
        {
            _snackbarMessage = "Eventet skal have en titel";
            await Task.Delay(3000).ContinueWith(_ => _snackbarMessage = null);
        }
        else if (_joinEvent.Deadline < DateTime.Now)
        {
            _snackbarMessage = "Deadline skal være i fremtiden";
            await Task.Delay(3000).ContinueWith(_ => _snackbarMessage = null);
        }
        else
        {
            await JsRuntime.InvokeVoidAsync("customFunctions.showDialog", "eventConfirmDialog");
        }
    }

    private async Task FinishJoinEvent()
    {
        var authenticationState = await AuthenticationStateTask;

        var user = authenticationState.User;

        var authorId = user.Claims.FirstOrDefault(c => c.Type == "sub")?.Value!;
        var name = user.Claims.FirstOrDefault(c => c.Type == "nickname")?.Value!;
        var email = user.Claims.FirstOrDefault(c => c.Type == "email")?.Value;

        var host = new Host();
        if (user.Identity is null || !user.Identity.IsAuthenticated)
        {
            host.AuthId = "1";
            host.Username = "Ukendt vært";
        }
        else
        {
            host.AuthId = authorId;
            host.Username = name;
            host.Email = email;
        }

        _joinEvent.Host = host;

        if (_hostCanAllShowtimes)
        {
            _joinEvent.Participants.Add(new Participant
            {
                AuthId = host.AuthId,
                Nickname = host.Username, Email = host.Email, Note = null,
                VotedFor = _joinEvent.Showtimes.Select(s => new ParticipantVote { ShowtimeId = s.Id, SelectedOption = _joinEvent.SelectOptions[YesVoteIndex] }).ToList(),
                JoinEventId = _joinEvent.Id
            });
        }

        var response = await KinoJoinHttpClient.PutJoinEventAsync(_joinEvent);
        var id = await response.Content.ReadAsStringAsync();

        _joinEvent.Id = int.Parse(id);

        await JsRuntime.InvokeVoidAsync("customFunctions.hideDialog", "eventDetailsDialog");
        await JsRuntime.InvokeVoidAsync("customFunctions.hideDialog", "eventConfirmDialog");
        await JsRuntime.InvokeVoidAsync("customFunctions.showDialog", "eventShareDialog");
    }

    private void OnVoteChange(ICollection<ParticipantVote> votes)
    {
        _availableShowtimeVotes = votes;
        //Save all show times, where voted yes
        _joinEvent.Showtimes = votes.Where(v => v.SelectedOption.VoteOption == _hostSelectOptions[YesVoteIndex].VoteOption)
            .Join(_availableShowtimes, v => v.ShowtimeId, s => s.Id,
                (_, showtime) => showtime).ToList();
    }

}